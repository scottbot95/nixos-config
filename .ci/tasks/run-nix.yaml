platform: linux
image_resource:
  type: registry-image
  source:
    repository: nixos/nix
params:
  CACHIX_NAME: scottbot95-homelab
  NIX_CONFIG: |
    extra-experimental-features = nix-command flakes
    max-jobs = 4
    cores = 4
inputs:
- name: source
- name: secrets
# caches:
# - path: nix-store
run:
  path: sh
  args:
  - -exc
  - |
    nix-channel --update
    nix-env -iA nixpkgs.cachix nixpkgs.bash

    cachix use $CACHIX_NAME

    # echo "extra-substituters = file://$PWD/nix-store" | tee -a /etc/nix/nix.conf > /dev/null
    # echo 'require-sigs = false' | tee -a /etc/nix/nix.conf > /dev/null

    cp -v secrets/* source/secrets/
    cd source
    cachix watch-exec $CACHIX_NAME nix-shell -- --run "((command)) ((args))"

    # nix copy --to file://$PWD/nix-store --all -v
