platform: linux
params:
  CACHIX_AUTH_TOKEN: ((cachix_token))
  HERCULES_CI_API_TOKEN: ((hci_token))
  NIX_CONFIG: |
    extra-experimental-features = nix-command flakes
    max-jobs = 4
    cores = 4
  SOPS_AGE_KEY: ((age_key))
inputs:
- name: source
- name: secrets
caches:
- path: nix-store
run:
  path: sh
  args:
  - -exc
  - |
    echo "extra-substituters = file://$PWD/nix-store" | tee -a /etc/nix/nix.conf > /dev/null
    echo 'require-sigs = false' | tee -a /etc/nix/nix.conf > /dev/null

    cp -v secrets/* source/secrets/
    cd source
    cachix watch-exec $CACHIX_NAME nix-shell -- --run "nixops ((command)) ((extra_flags))"

    nix copy --impure --to file://$PWD/nix-store .#deploy-homelab-prebuilt
